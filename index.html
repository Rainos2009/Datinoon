<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Datinoon - Gallery System</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ */
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; background: #fff; transition: 0.3s; }
    .header { border-bottom: 2px solid #000; padding: 0 50px; display: flex; justify-content: space-between; align-items: center; height: 70px; background: #fff; gap: 16px; }
    .logo-img { height: 40px; cursor: pointer; border: 1px solid #000; }
    .search-bar { border: 1px solid #000; padding: 8px 15px; width: 400px; max-width: 45vw; }

    /* ë¡œê·¸ì¸ ì˜ì—­ (ìš°ì¸¡ ìƒë‹¨) */
    #auth-area { display: flex; align-items: center; gap: 12px; min-width: 150px; justify-content: flex-end; }
    .login-btn { padding: 8px 20px; border: 2px solid #000; background: #000; color: #fff; font-weight: 900; cursor: pointer; }
    .logout-btn { padding: 4px 10px; border: 1px solid #000; background: #fff; cursor: pointer; font-size: 11px; }

    /* íƒ­ ë©”ë‰´ */
    .gallery-container { padding: 20px 50px 0 50px; display: flex; gap: 10px; flex-wrap: wrap; }
    .gallery-tab { padding: 8px 25px; border: 2px solid #000; background: #fff; font-weight: 900; cursor: pointer; color: #000; user-select: none; }
    .gallery-tab.active { background: #000; color: #fff; }

    /* ì»¨í…ì¸  ì˜ì—­ */
    .container { padding: 20px 50px; }
    .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .post-card { border: 2px solid #000; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fff; min-height: 180px; }
    .icon-box { width: 40px; height: 50px; border: 3px solid #000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }
    .meta { font-size: 12px; color: #888; margin-top: auto; }
    .title { font-weight: 800; font-size: 17px; margin-top: 5px; white-space: pre-wrap; word-break: break-word; }

    /* ìƒíƒœ ë©”ì‹œì§€ */
    .status { color: #888; padding: 20px; }
    .status.error { color: #b00000; }

    /* ê²Œì„ íƒ­ ì „ìš© ì§€ë„ ëª¨ë“œ */
    #world-map-container { display: none; width: 100%; margin-bottom: 30px; border: 2px solid #ff0000; background: #000; }
    .world-map { width: 100%; height: auto; display: block; filter: invert(1) hue-rotate(180deg); opacity: 0.7; }

    body.game-mode { background: #0c0c0c; color: #ff0000; cursor: crosshair !important; }
    body.game-mode #world-map-container { display: block; }
    body.game-mode .post-card { background: #1a1a1a; border-color: #ff0000; color: #fff; }
    body.game-mode .gallery-tab.active { background: #ff0000; border-color: #ff0000; }

    .write-btn { position: fixed; bottom: 30px; right: 30px; padding: 15px 35px; background: #000; color: #fff; font-weight: 900; border-radius: 50px; cursor: pointer; z-index: 1000; display: none; }

    /* ë°˜ì‘í˜• */
    @media (max-width: 900px) {
      .header { padding: 0 18px; }
      .gallery-container { padding: 18px 18px 0 18px; }
      .container { padding: 18px; }
      .search-bar { width: 100%; max-width: none; }
    }
  </style>
</head>

<body>
<header class="header">
  <img src="images/Datinoon_0.4.1.png" class="logo-img" onclick="location.reload()" alt="Datinoon" />
  <input
    type="text"
    id="search-input"
    class="search-bar"
    placeholder="ê°¤ëŸ¬ë¦¬ ë‚´ ê²€ìƒ‰..."
  />
  <div id="auth-area"></div>
</header>

<div class="gallery-container">
  <div class="gallery-tab active" data-gallery="ììœ ">ììœ  ê°¤ëŸ¬ë¦¬</div>
  <div class="gallery-tab" data-gallery="ê²Œì„">ê²Œì„ íƒ­</div>
  <div class="gallery-tab" data-gallery="ê³µì§€">ìš´ì˜ ê³µì§€</div>
</div>

<div class="container">
  <h2 id="current-gallery-title" style="margin-bottom: 20px;">ììœ  ê°¤ëŸ¬ë¦¬</h2>

  <div id="world-map-container">
    <img
      src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg"
      class="world-map"
      alt="World map"
    />
  </div>

  <div id="board-grid" class="board-grid"></div>
</div>

<button id="write-trigger" class="write-btn">+ ê¸€ì“°ê¸°</button>

<script>
  /************************************************************
   * 0) Supabase ì„¤ì •
   ************************************************************/
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';

  // supabase-js ë¡œë“œ ì‹¤íŒ¨ ë°©ì§€
  if (!window.supabase) {
    alert("Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„·/ìŠ¤í¬ë¦½íŠ¸ ë§í¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
  }

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let activeGallery = 'ììœ ';
  let currentSearch = '';
  const REDIRECT_URL = window.location.origin + window.location.pathname;

  const authArea = document.getElementById('auth-area');
  const writeBtn  = document.getElementById('write-trigger');
  const grid      = document.getElementById('board-grid');
  const titleEl   = document.getElementById('current-gallery-title');
  const searchEl  = document.getElementById('search-input');

  /************************************************************
   * 1) ìœ í‹¸: í™”ë©´ì— ì•ˆì „í•˜ê²Œ í…ìŠ¤íŠ¸ ë„£ê¸° (XSS ë°©ì§€)
   ************************************************************/
  function el(tag, className) {
    const node = document.createElement(tag);
    if (className) node.className = className;
    return node;
  }

  function setStatus(message, isError = false) {
    grid.innerHTML = '';
    const p = el('p', 'status' + (isError ? ' error' : ''));
    p.textContent = message;
    grid.appendChild(p);
  }

  /************************************************************
   * 2) ì¸ì¦ UI
   ************************************************************/
  function renderAuth(session) {
    authArea.innerHTML = '';

    if (session && session.user) {
      const name =
        (session.user.user_metadata && (session.user.user_metadata.full_name || session.user.user_metadata.name)) ||
        session.user.email ||
        "ì‚¬ìš©ì";

      const span = el('span');
      span.textContent = `ğŸªª ${name}`;

      const logout = el('button', 'logout-btn');
      logout.type = 'button';
      logout.textContent = 'ë¡œê·¸ì•„ì›ƒ';
      logout.onclick = async () => {
        const { error } = await supabaseClient.auth.signOut();
        if (error) alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + error.message);
        location.reload();
      };

      authArea.appendChild(span);
      authArea.appendChild(logout);
      writeBtn.style.display = 'block';
    } else {
      const login = el('button', 'login-btn');
      login.type = 'button';
      login.textContent = 'ë¡œê·¸ì¸';
      login.onclick = handleLogin;

      authArea.appendChild(login);
      writeBtn.style.display = 'none';
    }
  }

  async function handleLogin() {
    const { error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: REDIRECT_URL }
    });
    if (error) alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
  }

  /************************************************************
   * 3) ê°¤ëŸ¬ë¦¬ íƒ­ ì „í™˜
   ************************************************************/
  function setGallery(galleryName) {
    activeGallery = galleryName;

    titleEl.textContent = galleryName + " ê°¤ëŸ¬ë¦¬";
    document.body.className = (galleryName === 'ê²Œì„' ? 'game-mode' : '');

    document.querySelectorAll('.gallery-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.gallery === galleryName);
    });

    // ê²€ìƒ‰ì–´ ìœ ì§€í•œ ì±„ë¡œ ë¡œë“œ
    loadPosts(activeGallery, currentSearch);
  }

  document.querySelectorAll('.gallery-tab').forEach(tab => {
    tab.addEventListener('click', () => setGallery(tab.dataset.gallery));
  });

  /************************************************************
   * 4) ê²Œì‹œê¸€ ë¡œë“œ (ê²€ìƒ‰ í¬í•¨) - ë¬¸ìì—´ innerHTML ì¡°ë¦½ ì•ˆ í•¨ (XSS ë°©ì§€)
   ************************************************************/
  async function loadPosts(gallery = 'ììœ ', searchTerm = '') {
    setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

    try {
      let query = supabaseClient
        .from('anonymous_posts')
        .select('*')
        .eq('gallery_name', gallery)
        .order('created_at', { ascending: false });

      if (searchTerm) query = query.ilike('content', `%${searchTerm}%`);

      const { data: posts, error } = await query;
      if (error) throw error;

      grid.innerHTML = '';

      if (!posts || posts.length === 0) {
        setStatus("ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      posts.forEach((p, idx) => {
        const card = el('div', 'post-card');

        const icon = el('div', 'icon-box');
        // 0 ê³ ì • ë§ê³ , ê·¸ëƒ¥ ë²ˆí˜¸ ëŠë‚Œìœ¼ë¡œ (ì›í•˜ë©´ ë‹¤ì‹œ 0ìœ¼ë¡œ ë°”ê¾¸ì…”ë„ ë©ë‹ˆë‹¤)
        icon.textContent = String((idx + 1) % 10);

        const content = el('div', 'title');
        content.textContent = (p && p.content) ? String(p.content) : '';

        const meta = el('div', 'meta');
        const author = (p && p.author) ? String(p.author) : 'ìµëª…';
        const dateStr = p && p.created_at
          ? new Date(p.created_at).toLocaleString('ko-KR')
          : '';
        meta.textContent = `${author} | ${dateStr}`;

        card.appendChild(icon);
        card.appendChild(content);
        card.appendChild(meta);

        grid.appendChild(card);
      });
    } catch (e) {
      setStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (e && e.message ? e.message : String(e)), true);
    }
  }

  /************************************************************
   * 5) ê²€ìƒ‰ (ì—”í„° ëˆ„ë¥´ë©´ ê²€ìƒ‰)
   ************************************************************/
  searchEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      currentSearch = (searchEl.value || '').trim();
      loadPosts(activeGallery, currentSearch);
    }
  });

  /************************************************************
   * 6) ì‹œì‘í•  ë•Œ: ì„¸ì…˜ í™•ì¸ + ê²Œì‹œê¸€ ë¡œë“œ
   ************************************************************/
  window.addEventListener('load', async () => {
    // 1) ì§€ê¸ˆ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ â†’ ë²„íŠ¼ í‘œì‹œ
    const { data, error } = await supabaseClient.auth.getSession();
    if (error) {
      // ì„¸ì…˜ í™•ì¸ì´ ì‹¤íŒ¨í•´ë„ ê²Œì‹œê¸€ì€ ë³´ì—¬ì¤„ ìˆ˜ ìˆìœ¼ë‹ˆ, ë²„íŠ¼ë§Œ ë¡œê·¸ì¸ìœ¼ë¡œ ë‘ 
      renderAuth(null);
    } else {
      renderAuth(data.session);
    }

    // 2) ê¸°ë³¸ ê²Œì‹œê¸€ ë¡œë“œ
    loadPosts(activeGallery, currentSearch);
  });

  /************************************************************
   * 7) ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ë³€í™” ë°˜ì˜
   *    (í•„ìš” ì´ìƒìœ¼ë¡œ ì¬ë¡œë“œí•˜ì§€ ì•Šê²Œ ìµœì†Œ ì²˜ë¦¬)
   ************************************************************/
  supabaseClient.auth.onAuthStateChange((event, session) => {
    renderAuth(session);
    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë•Œë§Œ ëª©ë¡ ì¬ë¡œë“œ
    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
      loadPosts(activeGallery, currentSearch);
    }
  });

  /************************************************************
   * 8) ê¸€ì“°ê¸° ë²„íŠ¼(ì¼ë‹¨ ëˆŒë €ì„ ë•Œ ì•ˆë‚´ë§Œ)
   ************************************************************/
  writeBtn.addEventListener('click', () => {
    alert("ê¸€ì“°ê¸° ê¸°ëŠ¥ì€ ì•„ì§ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. (ì›í•˜ì‹œë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë§Œë“¤ì–´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
  });
</script>
</body>
</html>