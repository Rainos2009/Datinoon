<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Datinoon - Gallery System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; background: #fff; }
    
    /* í—¤ë” êµ¬ì¡° ìˆ˜ì •: ë¡œê·¸ì¸ ì˜ì—­ì´ í™•ì‹¤íˆ ìš°ì¸¡ì— ë°°ì¹˜ë˜ë„ë¡ ì„¤ì • */
    .header { 
      border-bottom: 2px solid #000; 
      padding: 0 50px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      height: 70px; 
      background: #fff;
    }
    .logo-img { height: 40px; cursor: pointer; border: 1px solid #000; }
    
    /* ë¡œê·¸ì¸ ì˜ì—­: í°ìƒ‰ ë°°ê²½ì—ì„œë„ ì˜ ë³´ì´ê²Œ ê²€ì •ìƒ‰ í…Œë‘ë¦¬ì™€ ê¸€ììƒ‰ ì§€ì • */
    #auth-area { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      font-weight: bold;
    }
    .login-btn { 
      padding: 8px 20px; 
      border: 2px solid #000; 
      background: #000; 
      color: #fff; 
      font-weight: 900; 
      cursor: pointer; 
      font-size: 14px;
    }
    .logout-btn {
      padding: 4px 10px;
      border: 1px solid #000;
      background: #fff;
      cursor: pointer;
      font-size: 11px;
    }

    /* ê°¤ëŸ¬ë¦¬ íƒ­ ë° ë ˆì´ì•„ì›ƒ */
    .gallery-container { padding: 20px 50px 0 50px; display: flex; gap: 10px; }
    .gallery-tab { padding: 8px 25px; border: 2px solid #000; background: #fff; font-weight: 900; cursor: pointer; color: #000; }
    .gallery-tab.active { background: #000; color: #fff; }

    .container { padding: 20px 50px; }
    .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .post-card { border: 2px solid #000; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fff; }
    .icon-box { width: 40px; height: 50px; border: 3px solid #000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }

    /* ê²Œì„ íƒ­ ì „ìš© */
    #world-map-container { display: none; width: 100%; margin-bottom: 30px; border: 2px solid #ff0000; }
    body.game-mode #world-map-container { display: block; }
    body.game-mode { background: #0c0c0c; color: #ff0000; }
  </style>
</head>
<body>

<header class="header">
  <img src="images/Datinoon_0.4.1.png" class="logo-img" onclick="location.reload()">
  <div id="auth-area"></div>
</header>

<div class="gallery-container">
  <div class="gallery-tab active" onclick="switchGallery('ììœ ', this)">ììœ  ê°¤ëŸ¬ë¦¬</div>
  <div class="gallery-tab" onclick="switchGallery('ê²Œì„', this)">ê²Œì„ íƒ­</div>
</div>

<div class="container">
  <h2 id="current-gallery-title">ììœ  ê°¤ëŸ¬ë¦¬</h2>
  <div id="world-map-container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg" style="width:100%; filter: invert(1);">
  </div>
  <div id="board-grid" class="board-grid"></div>
</div>

<script>
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const REDIRECT_URL = window.location.origin + window.location.pathname;

  // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë Œë”ë§ í•¨ìˆ˜ë¥¼ ë¶„ë¦¬í•˜ì—¬ í™•ì‹¤íˆ ë™ì‘í•˜ê²Œ í•¨
  function renderAuth(session) {
    const authArea = document.getElementById('auth-area');
    if (session) {
      const name = session.user.user_metadata.full_name || "ì‚¬ìš©ì";
      authArea.innerHTML = `
        <span>ğŸªª ${name}</span>
        <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      `;
    } else {
      authArea.innerHTML = `
        <button class="login-btn" onclick="handleGoogleLogin()">Google ë¡œê·¸ì¸</button>
      `;
    }
  }

  async function handleGoogleLogin() { 
    await supabaseClient.auth.signInWithOAuth({ 
      provider: 'google', 
      options: { redirectTo: REDIRECT_URL } 
    }); 
  }

  async function handleLogout() {
    await supabaseClient.auth.signOut();
    location.reload();
  }

  supabaseClient.auth.onAuthStateChange((event, session) => {
    renderAuth(session);
    loadPosts();
  });

  function switchGallery(galleryName, element) {
    document.body.className = (galleryName === 'ê²Œì„' ? 'game-mode' : '');
    document.querySelectorAll('.gallery-tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    document.getElementById('current-gallery-title').innerText = galleryName + " ê°¤ëŸ¬ë¦¬";
    loadPosts(galleryName);
  }

  async function loadPosts(gallery = 'ììœ ') {
    const { data: posts } = await supabaseClient.from('anonymous_posts').select('*').eq('gallery_name', gallery).order('created_at', { ascending: false });
    const grid = document.getElementById('board-grid');
    grid.innerHTML = (posts && posts.length > 0) ? posts.map(p => `
      <div class="post-card">
        <div class="icon-box">0</div>
        <div style="font-weight:bold;">${p.content}</div>
        <div style="font-size:11px; color:#888;">${p.author} | ${new Date(p.created_at).toLocaleDateString()}</div>
      </div>
    `).join('') : '<p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  }

  window.onload = () => {
    // ì´ˆê¸° ì„¸ì…˜ ì²´í¬
    supabaseClient.auth.getSession().then(({data}) => renderAuth(data.session));
    loadPosts();
  };
</script>
</body>
</html>