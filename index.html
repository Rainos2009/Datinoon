<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Datinoon v0.6.9 - Empire Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --main-border: 2px solid #000; --war-red: #ff4d4d; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; }
    
    /* í—¤ë” ìŠ¤íƒ€ì¼ ë³´ê°• */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: var(--main-border); background: #fff; height: 70px; z-index: 2000; position: relative; }
    
    /* ìœ ì € ë©”ë‰´ ìŠ¤íƒ€ì¼ (ì‹ ë¶„ì¦ ë©”ë‰´ë¥¼ ìœ„í•´ í•„ìˆ˜) */
    .user-zone { position: relative; display: flex; align-items: center; }
    .user-pill { display: none; align-items: center; cursor: pointer; border: var(--main-border); padding: 5px 12px; background: #fff; margin-left: 10px; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #000; margin-left: 10px; }
    .dropdown-menu { display: none; position: absolute; top: 50px; right: 0; width: 160px; background: #fff; border: var(--main-border); box-shadow: 5px 5px 0 #000; z-index: 2001; }
    .dropdown-item { padding: 12px; font-weight: 900; font-size: 13px; cursor: pointer; border-bottom: 1px solid #eee; }
    .dropdown-item:hover { background: #f0f0f0; }

    #map { width: 100vw; height: calc(100vh - 70px); background: #000; }
    
    /* ê²Œì‹œíŒ ë ˆì´ì–´ */
    #board-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
    .board-window { width: 90%; max-width: 500px; background: #fff; border: var(--main-border); padding: 20px; box-shadow: 10px 10px 0 #000; }
    .close-btn { float: right; cursor: pointer; font-weight: 900; }
  </style>
</head>
<body>

<header class="header">
  <div style="display:flex; align-items:center;">
    <img src="images/Datinoon 0.3.2.png" height="45" style="border:var(--main-border); cursor:pointer;" onclick="location.reload()" onerror="this.src='https://via.placeholder.com/120x40?text=Datinoon'">
    <span style="margin-left:15px; font-weight:900;">ğŸŒ ì œêµ­ ê±´ì„¤ì˜ ì‹œëŒ€</span>
  </div>
  
  <div class="user-zone">
    <div id="login-btn" style="cursor:pointer; font-weight:900; border:var(--main-border); padding:8px 15px;" onclick="handleGoogleLogin()">ë¡œê·¸ì¸</div>
    
    <div id="user-profile" class="user-pill" onclick="toggleUserMenu(event)">
      <div style="text-align:right;">
        <div id="user-rank" style="font-size:11px; font-weight:900; color:#4d94ff;">ë¡œë”© ì¤‘</div>
        <div id="user-display-name" style="font-size:14px; font-weight:900;">ì‹œë¯¼</div>
      </div>
      <img id="user-img" src="" class="user-avatar">
    </div>

    <div id="dropdown-menu" class="dropdown-menu">
      <div class="dropdown-item" onclick="location.href='profile.html'">ğŸªª ì‹ ë¶„ì¦ í™•ì¸</div>
      <div class="dropdown-item" onclick="handleLogout()" style="color:red;">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
    </div>
  </div>
</header>

<div id="map"></div>

<div id="board-overlay">
  <div class="board-window">
    <span class="close-btn" onclick="closeBoard()">[ë‹«ê¸°]</span>
    <h2 id="board-title">êµ­ê°€ ê²Œì‹œíŒ</h2>
    <hr border="1">
    <div id="post-list" style="height:200px; overflow-y:auto; margin-bottom:15px; font-size:14px;">ê²Œì‹œê¸€ ë¡œë”© ì¤‘...</div>
    <input id="post-input" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="width:70%; padding:5px;">
    <button onclick="writePost()" style="width:20%; padding:5px; font-weight:900;">ì „ì†¡</button>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let currentRank = "ì‹œë¯¼";
  let currentPixelId = null;
  const PIXEL_SIZE = 0.01;

  const map = L.map('map', { zoomControl: false }).setView([35.8714, 128.6014], 10); // ëŒ€êµ¬/ì•ˆë™ ê·¼ì²˜
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

  // 1. ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ ë° UI ì—…ë°ì´íŠ¸ (ë¡œë”© ë©ˆì¶¤ í•´ê²°)
  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (session) {
      currentUser = session.user.user_metadata;
      document.getElementById('login-btn').style.display = 'none';
      document.getElementById('user-profile').style.display = 'flex';
      
      // ì¼ë‹¨ êµ¬ê¸€ ì •ë³´ë¡œ ì¦‰ì‹œ í‘œì‹œ (ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
      document.getElementById('user-display-name').textContent = currentUser.full_name;
      document.getElementById('user-img').src = currentUser.avatar_url;

      // DBì—ì„œ ê³„ê¸‰ ê°€ì ¸ì˜¤ê¸° (ì‹¤íŒ¨ ì‹œ ì‹œë¯¼ ìœ ì§€)
      try {
        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if (profile) currentRank = profile.Rank;
      } catch (e) { console.log("ê³„ê¸‰ ë¡œë“œ ì‹¤íŒ¨, ì‹œë¯¼ìœ¼ë¡œ ì„¤ì •"); }

      document.getElementById('user-rank').textContent = `ğŸ  ${currentRank}`;
      if (currentRank === 'ëŒ€í†µë ¹') document.getElementById('user-rank').style.color = '#ff4d4d';
      
      loadTerritories();
    }
  });

  // 2. ì§€ë„ í´ë¦­ ë¡œì§: ë¬´í•œ í™•ì¥ ì ìš© (íŒì—… ì œê±°)
  map.on('click', async function(e) {
    if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    
    const lat = Math.floor(e.latlng.lat / PIXEL_SIZE) * PIXEL_SIZE;
    const lng = Math.floor(e.latlng.lng / PIXEL_SIZE) * PIXEL_SIZE;
    const pixelId = `${lat.toFixed(2)}_${lng.toFixed(2)}`;

    // ì´ë¯¸ ë‚¨ì˜ ë•…ì¸ì§€ í™•ì¸
    const { data: nation } = await supabaseClient.from('territories').select('*').eq('id', pixelId).single();

    if (nation) {
      openBoard(pixelId, nation.owner_name); // ê²Œì‹œíŒ ì—´ê¸°
    } else {
      // ë‚´ ë•…ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸ (ìˆìœ¼ë©´ íŒì—… ì—†ì´ ì¦‰ì‹œ ì ë ¹)
      const { data: myLand } = await supabaseClient.from('territories').select('id').eq('owner_name', currentUser.full_name).limit(1);
      
      if (myLand && myLand.length > 0) {
        // [í™•ì¥ ëª¨ë“œ] ë¬»ì§€ ì•Šê³  ì ë ¹
        await supabaseClient.from('territories').insert([{ id: pixelId, lat, lng, owner_name: currentUser.full_name }]);
        drawPixel(lat, lng, currentUser.full_name, pixelId);
      } else {
        // [ì²« ê±´êµ­] ê±´êµ­ ì„ í¬ í™•ì¸
        if (confirm(`ğŸš© ${pixelId} ì¢Œí‘œì— ë‹¹ì‹ ì˜ ì²« êµ­ê°€ë¥¼ ì„ í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          await supabaseClient.from('territories').insert([{ id: pixelId, lat, lng, owner_name: currentUser.full_name }]);
          drawPixel(lat, lng, currentUser.full_name, pixelId);
        }
      }
    }
  });

  function drawPixel(lat, lng, name, id) {
    const rect = L.rectangle([[lat, lng], [lat + PIXEL_SIZE, lng + PIXEL_SIZE]], { color: "#ff4d4d", weight: 1, fillOpacity: 0.5, fillColor: "#ff4d4d" }).addTo(map);
    rect.bindTooltip(`${name}`);
    rect.on('click', () => { /* í´ë¦­ ì´ë²¤íŠ¸ëŠ” map.onì—ì„œ ì²˜ë¦¬ë¨ */ });
  }

  // ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥ (ì‹ ë¶„ì¦ ë³´ì´ê¸°)
  function toggleUserMenu(e) { 
    e.stopPropagation(); 
    const menu = document.getElementById('dropdown-menu'); 
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; 
  }
  
  // í™”ë©´ ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ë©”ë‰´ ë‹«ê¸°
  window.onclick = () => { document.getElementById('dropdown-menu').style.display = 'none'; }

  // ê²Œì‹œíŒ ê´€ë ¨ í•¨ìˆ˜ë“¤
  function openBoard(id, name) {
    currentPixelId = id;
    document.getElementById('board-overlay').style.display = 'flex';
    document.getElementById('board-title').textContent = `${name}ì˜ ì˜í† `;
    loadPosts(id);
  }
  function closeBoard() { document.getElementById('board-overlay').style.display = 'none'; }
  
  async function loadPosts(id) {
    const { data: posts } = await supabaseClient.from('pixel_posts').select('*').eq('pixel_id', id);
    const list = document.getElementById('post-list');
    list.innerHTML = posts && posts.length ? posts.map(p => `<div style="padding:5px; border-bottom:1px solid #eee;"><b>${p.author_name}</b>: ${p.content}</div>`).join('') : "<div style='padding:10px; color:#888;'>ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
  }

  async function writePost() {
    const content = document.getElementById('post-input').value;
    if(!content) return;
    await supabaseClient.from('pixel_posts').insert([{ pixel_id: currentPixelId, content, author_name: currentUser.full_name }]);
    document.getElementById('post-input').value = "";
    loadPosts(currentPixelId);
  }

  async function loadTerritories() {
    const { data: list } = await supabaseClient.from('territories').select('*');
    if (list) list.forEach(t => drawPixel(t.lat, t.lng, t.owner_name, t.id));
  }

  async function handleGoogleLogin() { await supabaseClient.auth.signInWithOAuth({ provider: 'google' }); }
  async function handleLogout() { await supabaseClient.auth.signOut(); location.reload(); }
</script>
</body>
</html>