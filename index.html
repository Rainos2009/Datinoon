<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Datinoon - Gallery System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ */
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; background: #fff; transition: 0.3s; }
    .header { border-bottom: 2px solid #000; padding: 0 50px; display: flex; justify-content: space-between; align-items: center; height: 70px; background: #fff; }
    .logo-img { height: 40px; cursor: pointer; border: 1px solid #000; }
    .search-bar { border: 1px solid #000; padding: 8px 15px; width: 400px; }
    
    /* ë¡œê·¸ì¸ ì˜ì—­ (ìš°ì¸¡ ìƒë‹¨) */
    #auth-area { display: flex; align-items: center; gap: 15px; min-width: 150px; justify-content: flex-end; }
    .login-btn { padding: 8px 20px; border: 2px solid #000; background: #000; color: #fff; font-weight: 900; cursor: pointer; }
    .logout-btn { padding: 4px 10px; border: 1px solid #000; background: #fff; cursor: pointer; font-size: 11px; }

    /* íƒ­ ë©”ë‰´ (3ê°œ ë³µêµ¬) */
    .gallery-container { padding: 20px 50px 0 50px; display: flex; gap: 10px; }
    .gallery-tab { padding: 8px 25px; border: 2px solid #000; background: #fff; font-weight: 900; cursor: pointer; color: #000; }
    .gallery-tab.active { background: #000; color: #fff; }

    /* ì»¨í…ì¸  ì˜ì—­ */
    .container { padding: 20px 50px; }
    .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .post-card { border: 2px solid #000; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fff; min-height: 180px; }
    .icon-box { width: 40px; height: 50px; border: 3px solid #000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }

    /* ê²Œì„ íƒ­ ì „ìš© ì§€ë„ ëª¨ë“œ */
    #world-map-container { display: none; width: 100%; margin-bottom: 30px; border: 2px solid #ff0000; background: #000; }
    .world-map { width: 100%; height: auto; display: block; filter: invert(1) hue-rotate(180deg); opacity: 0.7; }

    body.game-mode { background: #0c0c0c; color: #ff0000; cursor: crosshair !important; }
    body.game-mode #world-map-container { display: block; }
    body.game-mode .post-card { background: #1a1a1a; border-color: #ff0000; color: #fff; }
    body.game-mode .gallery-tab.active { background: #ff0000; border-color: #ff0000; }
    
    .write-btn { position: fixed; bottom: 30px; right: 30px; padding: 15px 35px; background: #000; color: #fff; font-weight: 900; border-radius: 50px; cursor: pointer; z-index: 1000; }
  </style>
</head>
<body>

<header class="header">
  <img src="images/Datinoon_0.4.1.png" class="logo-img" onclick="location.reload()">
  <input type="text" id="search-input" class="search-bar" placeholder="ê°¤ëŸ¬ë¦¬ ë‚´ ê²€ìƒ‰..." onkeyup="if(event.keyCode==13) loadPosts(activeGallery, this.value)">
  <div id="auth-area"></div>
</header>

<div class="gallery-container">
  <div class="gallery-tab active" onclick="switchGallery('ììœ ', this)">ììœ  ê°¤ëŸ¬ë¦¬</div>
  <div class="gallery-tab" onclick="switchGallery('ê²Œì„', this)">ê²Œì„ íƒ­</div>
  <div class="gallery-tab" onclick="switchGallery('ê³µì§€', this)">ìš´ì˜ ê³µì§€</div>
</div>

<div class="container">
  <h2 id="current-gallery-title" style="margin-bottom: 20px;">ììœ  ê°¤ëŸ¬ë¦¬</h2>
  <div id="world-map-container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg" class="world-map">
  </div>
  <div id="board-grid" class="board-grid"></div>
</div>

<button id="write-trigger" class="write-btn" style="display:none;">+ ê¸€ì“°ê¸°</button>

<script>
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let activeGallery = 'ììœ ';
  const REDIRECT_URL = window.location.origin + window.location.pathname;

  // ì¸ì¦ UI ë Œë”ë§
  function renderAuth(session) {
    const authArea = document.getElementById('auth-area');
    const writeBtn = document.getElementById('write-trigger');
    if (session) {
      const name = session.user.user_metadata.full_name || "ì‚¬ìš©ì";
      authArea.innerHTML = `<span>ğŸªª ${name}</span><button class="logout-btn" onclick="supabaseClient.auth.signOut().then(()=>location.reload())">ë¡œê·¸ì•„ì›ƒ</button>`;
      writeBtn.style.display = 'block';
    } else {
      authArea.innerHTML = `<button class="login-btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>`;
      writeBtn.style.display = 'none';
    }
  }

  async function handleLogin() {
    await supabaseClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: REDIRECT_URL } });
  }

  supabaseClient.auth.onAuthStateChange((event, session) => {
    renderAuth(session);
    loadPosts(activeGallery);
  });

  // íƒ­ ì „í™˜
  function switchGallery(galleryName, element) {
    activeGallery = galleryName;
    document.getElementById('current-gallery-title').innerText = galleryName + " ê°¤ëŸ¬ë¦¬";
    document.body.className = (galleryName === 'ê²Œì„' ? 'game-mode' : '');
    document.querySelectorAll('.gallery-tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    loadPosts(galleryName);
  }

  // ê²Œì‹œê¸€ ë¡œë“œ (ê²€ìƒ‰ ê¸°ëŠ¥ í¬í•¨)
  async function loadPosts(gallery = 'ììœ ', searchTerm = '') {
    let query = supabaseClient.from('anonymous_posts').select('*').eq('gallery_name', gallery).order('created_at', { ascending: false });
    if(searchTerm) query = query.ilike('content', `%${searchTerm}%`);
    
    const { data: posts } = await query;
    const grid = document.getElementById('board-grid');
    grid.innerHTML = (posts && posts.length > 0) ? posts.map(p => `
      <div class="post-card">
        <div class="icon-box">0</div>
        <div style="font-weight:bold; font-size:17px; margin-top:5px;">${p.content}</div>
        <div style="font-size:12px; color:#888; margin-top:auto;">${p.author} | ${new Date(p.created_at).toLocaleDateString()}</div>
      </div>
    `).join('') : '<p style="color:#888; padding:20px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  }

  window.onload = () => {
    supabaseClient.auth.getSession().then(({data}) => renderAuth(data.session));
    loadPosts();
  };
</script>
</body>
</html>