<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Datinoon v0.4.5 - Global Pixel War</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --main-border: 2px solid #000; --war-red: #ff4d4d; --exp-green: #2ecc71; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; }

    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    .header { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 0 30px; border-bottom: var(--main-border); background: #fff; 
      height: 70px; position: relative; z-index: 2000;
    }
    .logo-img { height: 45px; cursor: pointer; border: var(--main-border); }
    
    /* ìœ ì € êµ¬ì—­ ë° ë“œë¡­ë‹¤ìš´ */
    .user-zone { position: relative; }
    .user-pill { display: none; align-items: center; cursor: pointer; border: var(--main-border); padding: 5px 12px; background: #fff; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #000; margin-left: 10px; }
    .dropdown-menu { 
      display: none; position: absolute; top: 60px; right: 0; width: 180px; 
      background: #fff; border: var(--main-border); box-shadow: 5px 5px 0 #000; z-index: 2001; 
    }
    .dropdown-item { padding: 12px; font-weight: 900; font-size: 13px; cursor: pointer; border-bottom: 1px solid #eee; }
    .dropdown-item:hover { background: #f9f9f9; }

    /* ë©”ì¸ ì§€ë„ êµ¬ì—­ */
    #map { width: 100vw; height: calc(100vh - 70px); background: #000; }
    
    /* ëŒ€í†µë ¹ ì „ìš© ì•Œë¦¼ ì°½ */
    .status-panel {
      position: absolute; bottom: 30px; left: 30px; z-index: 1000;
      background: #fff; border: var(--main-border); padding: 15px; box-shadow: 8px 8px 0 #000;
    }
  </style>
</head>
<body>

<header class="header">
  <div class="left-zone">
    <img src="images/Datinoon 0.3.2.png" class="logo-img" onclick="location.reload()" onerror="this.src='https://via.placeholder.com/120x40?text=Datinoon'">
  </div>
  
  <div class="user-zone">
    <div id="login-btn" style="cursor:pointer; font-weight:900; border:var(--main-border); padding:8px 15px;" onclick="handleGoogleLogin()">ë¡œê·¸ì¸</div>
    <div id="user-profile" class="user-pill" onclick="toggleUserMenu(event)">
      <div style="text-align:right;">
        <div id="user-rank" style="font-size:11px; font-weight:900; color:#4d94ff;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div id="user-display-name" style="font-size:14px; font-weight:900;">ì‹œë¯¼</div>
      </div>
      <img id="user-img" src="" class="user-avatar">
    </div>
    
    <div id="dropdown-menu" class="dropdown-menu">
      <div class="dropdown-item" onclick="location.href='profile.html'">ğŸªª ì‹ ë¶„ì¦ í™•ì¸</div>
      <div class="dropdown-item" onclick="alert('Lv.10 ë‹¬ì„± ì‹œ ìŠ¹ê¸‰ ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!')">ğŸ–ï¸ ê³„ê¸‰ ìŠ¹ê¸‰ ì‹ ì²­</div>
      <div class="dropdown-item" onclick="handleLogout()" style="color:red;">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
    </div>
  </div>
</header>

<div id="map"></div>

<div class="status-panel" id="admin-panel">
  <div style="font-weight:900; font-size:1.1rem;">ğŸš© ì œêµ­ ì‘ì „ ì§€íœ˜ë¶€</div>
  <div id="map-notice" style="font-size:0.9rem; margin-top:5px; color:#666;">ì „ ì„¸ê³„ 1í”½ì…€ ë‹¨ìœ„ ì ë ¹ ê°€ëŠ¥</div>
</div>

<script>
  // 1. Supabase ì„¤ì •
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentRank = "ì‹œë¯¼";
  const PIXEL_SIZE = 0.01; // 1í”½ì…€ ê²©ì í¬ê¸°

  // 2. ì§€ë„ ì´ˆê¸°í™” (ì „ ì„¸ê³„ ëª¨ë“œ)
  const map = L.map('map', { zoomControl: false }).setView([35.8714, 128.6014], 5);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© Datinoon Empire'
  }).addTo(map);

  // 3. ì ë ¹ í´ë¦­ ì´ë²¤íŠ¸ (1í”½ì…€ì”© êµ­ê°€ ì„¸ìš°ê¸°)
  map.on('click', async function(e) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return alert("ë¡œê·¸ì¸ í›„ ì˜í† ë¥¼ ì ë ¹í•˜ì‹­ì‹œì˜¤!");

    const lat = Math.floor(e.latlng.lat / PIXEL_SIZE) * PIXEL_SIZE;
    const lng = Math.floor(e.latlng.lng / PIXEL_SIZE) * PIXEL_SIZE;

    // í”½ì…€ ê·¸ë¦¬ê¸° (ì§€ë„ ìœ„ ì‹œê°í™”)
    const bounds = [[lat, lng], [lat + PIXEL_SIZE, lng + PIXEL_SIZE]];
    const color = (currentRank === 'ëŒ€í†µë ¹') ? '#ff0000' : '#4d94ff'; // ëŒ€í†µë ¹ì€ ë¶‰ì€ ì˜í† 

    L.rectangle(bounds, {
      color: color, weight: 1, fillOpacity: 0.5, fillColor: color
    }).addTo(map).bindPopup(`<b>ì ë ¹ ì™„ë£Œ</b><br>ê³„ê¸‰: ${currentRank}`);

    // ì—¬ê¸°ì„œ Supabaseì˜ territories í…Œì´ë¸”ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    console.log(`í”½ì…€ ì ë ¹: ${lat}, ${lng} by ${currentRank}`);
  });

  // 4. ë¡œê·¸ì¸ ë° í”„ë¡œí•„ ì—°ë™
  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (session) {
      document.getElementById('login-btn').style.display = 'none';
      document.getElementById('user-profile').style.display = 'flex';
      document.getElementById('user-img').src = session.user.user_metadata.avatar_url;
      
      const { data: profile } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', session.user.id)
        .single();

      if (profile) {
        currentRank = profile.Rank;
        document.getElementById('user-rank').textContent = `ğŸ  ${profile.Rank}`;
        document.getElementById('user-display-name').textContent = session.user.user_metadata.full_name;
        
        if(currentRank === 'ëŒ€í†µë ¹') {
            document.getElementById('user-rank').style.color = '#ff4d4d';
        }
      }
    }
  });

  function toggleUserMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById('dropdown-menu');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
  }

  async function handleGoogleLogin() {
    await supabaseClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin + '/Datinoon/' } });
  }

  async function handleLogout() {
    await supabaseClient.auth.signOut();
    location.reload();
  }

  window.onclick = () => { document.getElementById('dropdown-menu').style.display = 'none'; }
</script>

</body>
</html>