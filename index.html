<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Datinoon v0.7.0 - Hearts of Iron Mode</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --main-border: 2px solid #000; --hoi-blue: #1e3a5f; --war-red: #cc0000; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; background: #111; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: var(--main-border); background: #eee; height: 70px; z-index: 2000; position: relative; }
    
    /* HOI4 ìŠ¤íƒ€ì¼ ìƒë‹¨ ìì›ë°” */
    .resource-bar { display: flex; gap: 20px; font-weight: 900; font-size: 14px; background: #333; color: #fff; padding: 5px 20px; border-bottom: 2px solid #000; }
    .pp-icon { color: #55ff55; } /* ì •ì¹˜ë ¥ ìƒ‰ìƒ */

    #map { width: 100vw; height: calc(100vh - 100px); background: #000; }
    
    /* ì‚¬ë‹¨ ì¼ì§€ (ê²Œì‹œíŒ) UI */
    #board-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
    .board-window { width: 90%; max-width: 450px; background: #e1e1e1; border: 4px double #333; padding: 20px; box-shadow: 10px 10px 0 #000; }
    .close-btn { float: right; cursor: pointer; font-weight: 900; color: #cc0000; }
  </style>
</head>
<body>

<div class="resource-bar">
  <span><span class="pp-icon">âš¡ ì •ì¹˜ë ¥:</span> <span id="pp-val">0</span></span>
  <span><span style="color:#ffcc00;">ğŸ–ï¸ ì´ ì˜í† :</span> <span id="land-val">0</span></span>
  <span id="user-status" style="margin-left:auto; color:#aaa;">ì „ì„  ëŒ€ê¸° ì¤‘...</span>
</div>

<header class="header">
  <div style="display:flex; align-items:center;">
    <img src="images/Datinoon 0.3.2.png" height="45" style="border:var(--main-border);" onclick="location.reload()">
    <span style="margin-left:15px; font-weight:900; font-size:20px;">ğŸ–ï¸ DATINOON: IRON STRATEGY</span>
  </div>
  <div id="user-info" style="font-weight:900; cursor:pointer;" onclick="location.href='profile.html'">ğŸªª ì‹ ë¶„ì¦ í™•ì¸</div>
</header>

<div id="map"></div>

<div id="board-overlay">
  <div class="board-window">
    <span class="close-btn" onclick="closeBoard()">[ë‹«ê¸°]</span>
    <h3 id="board-title">ğŸ“ ì‚¬ë‹¨ ë°°ì¹˜ êµ¬ì—­</h3>
    <hr>
    <div id="post-list" style="height:250px; overflow-y:auto; margin-bottom:15px; background:#fff; border:1px solid #999; padding:10px; font-size:13px;"></div>
    <input id="post-input" type="text" placeholder="ì‘ì „ ëª…ë ¹ ì…ë ¥..." style="width:75%; padding:8px; border:2px solid #333;">
    <button onclick="writePost()" style="width:20%; padding:8px; background:#333; color:#fff; font-weight:900;">ê¸°ë¡</button>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let politicalPower = 0;
  let myLandCount = 0;
  const PIXEL_SIZE = 0.01;

  // 1. ì •ì¹˜ë ¥ ìë™ ìƒì‚° (HOI4 ì‹œìŠ¤í…œ)
  setInterval(() => {
    if (currentUser) {
      politicalPower += 0.1;
      document.getElementById('pp-val').textContent = Math.floor(politicalPower);
    }
  }, 1000);

  const map = L.map('map', { zoomControl: false }).setView([35.8714, 128.6014], 10);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

  // 2. ì ë ¹(ì •ë‹¹í™”) ë° ì‚¬ë‹¨ ë°°ì¹˜ í´ë¦­ ì´ë²¤íŠ¸
  map.on('click', async function(e) {
    if (!currentUser) return alert("êµ° í†µìˆ˜ê¶Œì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    
    const lat = Math.floor(e.latlng.lat / PIXEL_SIZE) * PIXEL_SIZE;
    const lng = Math.floor(e.latlng.lng / PIXEL_SIZE) * PIXEL_SIZE;
    const pixelId = `${lat.toFixed(2)}_${lng.toFixed(2)}`;

    const { data: nation } = await supabaseClient.from('territories').select('*').eq('id', pixelId).single();

    if (nation) {
      openBoard(pixelId, nation.owner_name);
    } else {
      if (politicalPower < 10) return alert("âš¡ ì •ì¹˜ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: 10)");
      
      // ì¦‰ì‹œ ì •ë‹¹í™” ë° ì ë ¹
      politicalPower -= 10;
      const { error } = await supabaseClient.from('territories').insert([{ id: pixelId, lat, lng, owner_name: currentUser.full_name }]);
      
      if (!error) {
        drawPixel(lat, lng, currentUser.full_name);
        myLandCount++;
        document.getElementById('land-val').textContent = myLandCount;
      }
    }
  });

  function drawPixel(lat, lng, name) {
    L.rectangle([[lat, lng], [lat + PIXEL_SIZE, lng + PIXEL_SIZE]], { 
      color: "#cc0000", weight: 2, fillOpacity: 0.6, fillColor: "#cc0000" 
    }).addTo(map).bindTooltip(`[ì ë ¹ì§€] ì£¼ê¶Œì: ${name}`);
  }

  function openBoard(id, name) {
    currentPixelId = id;
    document.getElementById('board-overlay').style.display = 'flex';
    document.getElementById('board-title').textContent = `ğŸš© ${name} ì‚¬ë‹¨ ì‘ì „ ê¸°ë¡`;
    loadPosts(id);
  }

  function closeBoard() { document.getElementById('board-overlay').style.display = 'none'; }

  async function loadPosts(id) {
    const { data: posts } = await supabaseClient.from('pixel_posts').select('*').eq('pixel_id', id);
    const list = document.getElementById('post-list');
    list.innerHTML = posts && posts.length ? posts.map(p => `<div style="margin-bottom:8px;"><b>[ì „ë ¹]</b> ${p.content}</div>`).join('') : "ê¸°ë¡ëœ ì‘ì „ì´ ì—†ìŠµë‹ˆë‹¤.";
  }

  async function writePost() {
    const content = document.getElementById('post-input').value;
    if(!content) return;
    await supabaseClient.from('pixel_posts').insert([{ pixel_id: currentPixelId, content, author_name: currentUser.full_name }]);
    document.getElementById('post-input').value = "";
    loadPosts(currentPixelId);
  }

  // ë¡œê·¸ì¸ ê°ì§€ ë° ê¸°ì´ˆ ë°ì´í„° ë¡œë“œ
  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (session) {
      currentUser = session.user.user_metadata;
      document.getElementById('user-status').textContent = `ğŸ–ï¸ ${currentUser.full_name} ì‚¬ë ¹ê´€ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.`;
      
      const { data: myLands } = await supabaseClient.from('territories').select('id').eq('owner_name', currentUser.full_name);
      myLandCount = myLands ? myLands.length : 0;
      document.getElementById('land-val').textContent = myLandCount;
      
      loadTerritories();
    }
  });

  async function loadTerritories() {
    const { data: list } = await supabaseClient.from('territories').select('*');
    if (list) list.forEach(t => drawPixel(t.lat, t.lng, t.owner_name));
  }

  async function handleGoogleLogin() { await supabaseClient.auth.signInWithOAuth({ provider: 'google' }); }
</script>
</body>
</html>