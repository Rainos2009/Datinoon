<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Datinoon v0.5.2 - Empire Integrated</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --main-border: 2px solid #000; --war-red: #ff4d4d; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow-x: hidden; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: var(--main-border); background: #fff; height: 70px; position: sticky; top: 0; z-index: 2000; }
    .logo-img { height: 45px; cursor: pointer; border: var(--main-border); }
    .war-mode-btn { background: #000; color: #fff; border: none; padding: 10px 20px; font-weight: 900; cursor: pointer; margin-left: 15px; }
    #community-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 30px; }
    #war-map-view { display: none; width: 100vw; height: calc(100vh - 70px); position: relative; }
    #map { width: 100%; height: 100%; background: #000; }
    .user-zone { position: relative; }
    .user-pill { display: none; align-items: center; cursor: pointer; border: var(--main-border); padding: 5px 12px; background: #fff; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #000; margin-left: 10px; }
    .dropdown-menu { display: none; position: absolute; top: 60px; right: 0; width: 180px; background: #fff; border: var(--main-border); box-shadow: 5px 5px 0 #000; z-index: 2001; }
    .dropdown-item { padding: 12px; font-weight: 900; font-size: 13px; cursor: pointer; border-bottom: 1px solid #eee; }
    .status-panel { position: absolute; bottom: 30px; left: 30px; z-index: 1000; background: #fff; border: var(--main-border); padding: 15px; box-shadow: 8px 8px 0 #000; }
    .energy-bar { width: 100px; height: 10px; background: #eee; border: 1px solid #000; margin-top: 5px; }
    .energy-fill { width: 100%; height: 100%; background: #f1c40f; transition: 0.3s; }
  </style>
</head>
<body>

<header class="header">
  <div style="display:flex; align-items:center;">
    <img src="images/Datinoon 0.3.2.png" class="logo-img" onclick="location.reload()">
    <button class="war-mode-btn" id="view-toggle-btn" onclick="toggleView()">ğŸ—ºï¸ ì˜í†  ì „ìŸ ì§€ë„ë¡œ</button>
  </div>
  <div class="user-zone">
    <div id="login-btn" style="cursor:pointer; font-weight:900; border:var(--main-border); padding:8px 15px;" onclick="handleGoogleLogin()">ë¡œê·¸ì¸</div>
    <div id="user-profile" class="user-pill" onclick="toggleUserMenu(event)">
      <div style="text-align:right;">
        <div id="user-rank" style="font-size:11px; font-weight:900; color:#4d94ff;">ì¡°íšŒ ì¤‘...</div>
        <div id="user-display-name" style="font-size:14px; font-weight:900;">ì‹œë¯¼</div>
      </div>
      <img id="user-img" src="" class="user-avatar">
    </div>
    <div id="dropdown-menu" class="dropdown-menu">
      <div class="dropdown-item" onclick="location.href='profile.html'">ğŸªª ì‹ ë¶„ì¦ í™•ì¸</div>
      <div class="dropdown-item" onclick="handleLogout()" style="color:red;">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
    </div>
  </div>
</header>

<main id="community-view">
  <div style="border:var(--main-border); padding:40px; text-align:center;"><b>ğŸ“¸ ì‚¬ì§„ ì˜¬ë¦¬ê³  ì ë ¹í•˜ê¸°</b></div>
</main>

<section id="war-map-view">
  <div id="map"></div>
  <div class="status-panel">
    <div style="font-weight:900;">ğŸš© ì œêµ­ ì‘ì „ ì§€íœ˜ë¶€</div>
    <div class="energy-bar"><div id="energy-fill" class="energy-fill"></div></div>
    <div id="stat-text" style="font-size:0.8rem; margin-top:5px; font-weight:bold;">ê¸°ë ¥: 100 / ê³µê²©ë ¥: 10</div>
  </div>
</section>

<script>
  const SUPABASE_URL = 'https://lhundplpkgafoozxmiyi.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_jngaJT3f3TOfJciY8LTW9A_AStej1TQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentRank = "ì‹œë¯¼";
  let currentUserName = "";
  let myEnergy = 100;
  let myPower = 10;
  const PIXEL_SIZE = 0.01;

  const map = L.map('map', { zoomControl: false }).setView([35.8714, 128.6014], 5);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

  function toggleView() {
    const comm = document.getElementById('community-view');
    const war = document.getElementById('war-map-view');
    const btn = document.getElementById('view-toggle-btn');
    if (comm.style.display !== 'none') {
      comm.style.display = 'none'; war.style.display = 'block'; btn.textContent = "ğŸ  í™ˆ ê·¸ë¦¬ë“œë¡œ";
      setTimeout(() => { map.invalidateSize(); loadTerritories(); }, 200);
    } else {
      comm.style.display = 'grid'; war.style.display = 'none'; btn.textContent = "ğŸ—ºï¸ ì˜í†  ì „ìŸ ì§€ë„ë¡œ";
    }
  }

  async function loadTerritories() {
    const { data: territories } = await supabaseClient.from('territories').select('*');
    if (territories) territories.forEach(t => drawPixel(t.lat, t.lng, t.owner_rank, t.owner_name));
  }

  function drawPixel(lat, lng, rank, name) {
    const bounds = [[lat, lng], [lat + PIXEL_SIZE, lng + PIXEL_SIZE]];
    L.rectangle(bounds, { color: "#ff4d4d", weight: 1, fillOpacity: 0.5, fillColor: "#ff4d4d" })
     .addTo(map).bindPopup(`<b>ì ë ¹ì§€</b><br>ì§€íœ˜ê´€: ${name} (${rank})`);
  }

  map.on('click', async function(e) {
    if (currentRank !== 'êµ°ì¸' && currentRank !== 'ëŒ€í†µë ¹') return alert("âš ï¸ êµ°ë¶€ì˜ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    if (myEnergy < 10) return alert("ğŸš¨ ë³´ê¸‰ ëŒ€ê¸° ì¤‘ (ê¸°ë ¥ ë¶€ì¡±)");
    const lat = Math.floor(e.latlng.lat / PIXEL_SIZE) * PIXEL_SIZE;
    const lng = Math.floor(e.latlng.lng / PIXEL_SIZE) * PIXEL_SIZE;
    const { error } = await supabaseClient.from('territories').insert([{ lat, lng, owner_name: currentUserName, owner_rank: currentRank }]);
    if (!error) { myEnergy -= 10; updateUI(); drawPixel(lat, lng, currentRank, currentUserName); }
  });

  function updateUI() {
    document.getElementById('energy-fill').style.width = myEnergy + "%";
    document.getElementById('stat-text').textContent = `ê¸°ë ¥: ${myEnergy} / ê³µê²©ë ¥: ${myPower}`;
  }

  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (session) {
      document.getElementById('login-btn').style.display = 'none';
      document.getElementById('user-profile').style.display = 'flex';
      currentUserName = session.user.user_metadata.full_name;
      document.getElementById('user-display-name').textContent = currentUserName;
      document.getElementById('user-img').src = session.user.user_metadata.avatar_url;

      const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
      currentRank = profile ? profile.Rank : "ì‹œë¯¼";
      myPower = (currentRank === 'ëŒ€í†µë ¹') ? 999 : 10;
      document.getElementById('user-rank').textContent = `ğŸ  ${currentRank}`;
      if(currentRank === 'ëŒ€í†µë ¹') document.getElementById('user-rank').style.color = '#ff4d4d';
      updateUI();
    }
  });

  function toggleUserMenu(e) { e.stopPropagation(); const menu = document.getElementById('dropdown-menu'); menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; }
  async function handleGoogleLogin() { await supabaseClient.auth.signInWithOAuth({ provider: 'google' }); }
  async function handleLogout() { await supabaseClient.auth.signOut(); location.reload(); }
  window.onclick = () => { document.getElementById('dropdown-menu').style.display = 'none'; }
</script>
</body>
</html>